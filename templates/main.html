<!DOCTYPE html>
<html>

<head>
    <title>candidatos.info</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/main.css">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>
    <form id="selections" name="mainForm" class="mainForm" method="POST" enctype="multipart/form-data">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <select class="form-control select2" id="statesSelect" name="state">
                        <option>Selecione um estado</option>
                        {{ range .States }}
                        <option>{{ . }}</option>
                        {{ end }}
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <select class="form-control select2" id="citiesSelect" name="city">
                        <option>Selecione uma cidade</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <select name="role" id="rolesSelect" class="form-control select2" role="role">
                        <option>Selecione um cargo</option>
                        {{ range .CandidateTypes }}
                        <option>{{ . }}</option>
                        {{ end }}
                    </select>
                </div>
            </div>
        </div>
    </form>
    <div class="fab">
        <button class="main">
        </button>
    </div>
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <label for="fname">Digite seu email cadastrado no TSE</label>
            <input type="text" id="candidateEmail" name="candidateEmail">
            <button id='testButton'>Test</button>
        </div>
    </div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
    <script>
        const electionYear = 2016;
        $('.select2').select2();
        $(document).on('change', '#statesSelect', function () {
            const selectedState = ($("#statesSelect").val());
            if (selectedState != "Selecione um estado") { // if one state is selected
                $.get("/api/v1/cities?state=" + selectedState, {}, function (data, textStatus, jqXHR) {
                    var $cities = $("#citiesSelect");
                    $cities.empty();
                    $.each(data, function (key, value) {
                        $cities.append($("<option></option>").text(value).attr("value", value));
                    });
                });
            }
        });
        $(document).on("change", "#rolesSelect", function () {
            const selectedState = $("#statesSelect").val();
            const selectedCity = $("#citiesSelect").val();
            const selectedRole = $("#rolesSelect").val();
            if (selectedRole === "Selecione um tipo de candidato") {
                alert("Selecione um tipo de candidato!");
                return;
            }
            if (selectedState === "Selecione um estado") {
                alert("Selectione um estado!");
                return;
            } else if (selectedCity === "Selecione uma cidade" || selectedCity === "" || selectedCity == undefined || selectedCity == null) {
                alert("Selecione uma cidade");
                return;
            } else {
                $("#selections").attr("action", "/profiles/" + electionYear + "?city=" + selectedCity + "&state=" + selectedState + "&role=" + selectedRole);
                document.forms["mainForm"].submit();
            }
        });
        var modal = document.getElementById("myModal");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        document.querySelector('.fab .main').addEventListener('click', function () {
            modal.style.display = "block";
        });

        $('#testButton').on('click', function () {
            const givenEmail = $("#candidateEmail").val();
            if (givenEmail === "" || givenEmail === null || givenEmail === undefined) {
                alert("Preencha o campo de email!");
            } else {
                $.post("/api/v1/profiles", { "email": givenEmail }, function (data, status) {
                    alert(data.Message);
                    modal.style.display = "none";
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 404) {
                        alert(JSON.parse(jqXHR.responseText).Message);
                    } else {
                        alert("Erro internto!");
                        modal.style.display = "none";
                    }
                });;
            }
        });
    </script>
</body>

</html>