{{define "filters"}}
    <form
        name="filtros"
        id="filtros"
        method="get"
    >
        <div class="form-row">
            <div class="form-group col-8">
                <select
                    class="custom-select"
                    name="estado"
                >
                    <option value="">Escolha um estado</option>
                    {{range $i, $val := .AllStates}}
                        <option
                            value="{{$val}}"
                            {{ if eq $.Filters.State $val }} selected {{end}}
                        >
                            {{$val}}
                        </option>
                    {{end}}
                </select>
            </div>
            <div class="form-group col-4">
                <input class="form-control" type="year" name="ano" value="{{.Filters.Year}}" placeholder="Ano" />
            </div>
        </div>

        {{if .Filters.State}}
        <div class="form-row">
            <div class="form-group col-8">
                <select name="cidade" class="custom-select">
                    <option value="">Escolha uma Cidade</option>
                    {{range $i, $v := .CitiesOfState}}
                        <option
                            value="{{$v}}"
                            {{if eq $v $.Filters.City}}selected{{end}}
                        >
                            {{$v}}
                        </option>
                    {{end}}
                </select>
            </div>
            <div class="form-group col-4">
                <select name="cargo" class="custom-select">
                    <option value="">Cargo</option>
                    {{range $i, $v := .AllPositions}}
                        <option
                            value="{{$v}}"
                            {{if eq $v $.Filters.Position}}selected{{end}}
                        >
                            {{$v}}
                        </option>
                    {{end}}
                </select>
            </div>
        </div>
        {{end}}
    </form>
{{end}}

{{define "candidateTransparency"}}
<span class="d-flex justify-content-center align-items-center">
    <span
        class="
            rounded-circle d-flex align-items-center justify-content-center
            {{if (lt .TransparencyPercentage 25) }}
                bg-danger
            {{else if (and (ge .TransparencyPercentage 25) (lt .TransparencyPercentage 50))}}
                bg-orange
            {{else if (and (ge .TransparencyPercentage 50) (lt .TransparencyPercentage 75))}}
                bg-warning
            {{else if (and (ge .TransparencyPercentage 75) (lt .TransparencyPercentage 100))}}
                bg-teal
            {{else}}
                bg-success
            {{end}}
        "
        style="height: 14px; width: 14px; margin-right: 5px;"
    >
        <svg style="height: 11px; width: auto;" viewBox="0 0 13 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 6.00018L6.50012 11.0001L5.00009 6.00009L8 6.00018Z" fill="#E6F5FF" stroke="#4975A9" stroke-width="0.75" stroke-linejoin="round"/>
            <path d="M11 6L6.5 11L7.99981 6.00018L11 6Z" fill="#E6F5FF" stroke="#4975A9" stroke-width="0.75" stroke-linejoin="round"/>
            <path d="M10.9998 6.00021L10 3.00006L8 3.00006L8 6.00021L10.9998 6.00021Z" fill="#E6F5FF" stroke="#4975A9" stroke-width="0.75" stroke-linejoin="round"/>
            <path d="M5 6L5 3L3 3L2 6L5 6Z" fill="#E6F5FF" stroke="#4975A9" stroke-width="0.75" stroke-linejoin="round"/>
            <path d="M8 6.00012L8 3.00012L5 3.00012L5 6.00012L8 6.00012Z" fill="#E6F5FF" stroke="#4975A9" stroke-width="0.75" stroke-linejoin="round"/>
            <path d="M2 6.00006L6.5 11.0001L5 6.00006L2 6.00006Z" fill="#E6F5FF" stroke="#4975A9" stroke-width="0.75" stroke-linejoin="round"/>
        </svg>
    </span>

    <span
        class="text-center"
        style="font-size: 9px;"
    >
        {{if (lt .TransparencyPercentage 25)}}
            Perfil pouco transparente.
        {{else}}
            Perfil {{.TransparencyPercentage}}% transparente.
        {{end}}
    </span>
</span>
{{end}}

{{define "candidatoCard"}}
<div
    class="
        card card-shadow
        {{if lt .TransparencyPercentage 25}}
            border-danger
        {{else if and (ge .TransparencyPercentage 25) (lt .TransparencyPercentage 50)}}
            border-orange
        {{else if and (ge .TransparencyPercentage 50) (lt .TransparencyPercentage 75)}}
            border-warning
        {{else if and (ge .TransparencyPercentage 75) (lt .TransparencyPercentage 100)}}
            border-teal
        {{else}}
            border-success
        {{end}}
    "
    style="border-width: 5px 0 0;"
>
    <div class="mt-2">
        {{template "candidateTransparency" .}}
    </div>
    <img
        class="rounded-circle cover mx-auto p-1"
        src="{{.ImageURL}}"
        alt="Card image cap"
        style="width: 128px; height: 128px;"
    />
    <div class="card-body">
        <h5 class="card-title text-dark mb-0">{{.Name}}</h5>
        <small class="card-text text-dark" style="font-size: 10px;">{{.City}}</small>
        <p class="card-text text-text mb-0">{{.Position}}</p>
        <p class="card-text text-text">{{.CandidatureNumber}}</p>
        <div >
        {{range .Descriptions}}
            <span class="badge badge-pill bg-button" style="font-size: 9px">{{.Tag}}</span>
        {{end}}
        </div>
    </div>
</div>
{{end}}

{{define "candidatos"}}
    <div>
        <div
            class="row"
            style="margin-left: -8px; margin-right: -8px;"
            id="candidatesList"
        >
            {{range .Candidates}}
            <div class="col-6 col-md-4 col-lg-2" style="padding-left: 8px; padding-right: 8px; margin-bottom: 16px;">
                {{template "candidatoCard" .}}
            </div>
            {{end}}
        </div>

        <div class="load-more-btn text-center">
            <a href="{{.LoadMoreUrl}}" class="btn btn-link btn-sm text-dark mx-auto">ver mais</a>
        </div>
    </div>
{{end}}

{{define "emptyCandidatos"}}
<div class="jumbotron mt-4" style="padding: 0;">
    <p class="lead">Busque por candidaturas com propostas que você mais acredita!</p>
</div>
{{end}}

{{define "content"}}
    <div class="container mt-2" id="home">
        {{template "filters" .}}

        <div class="mt-2" id="candidates">
            {{ if gt (len .Candidates) 0 }}
                {{template "candidatos" .}}
            {{else}}
                {{template "emptyCandidatos" .}}
            {{end}}
        </div>
    </div>
{{end}}

{{define "scripts"}}
<script>
    $(function () {
        var $home = $('#home');

        $home.on('click', '.load-more-btn', function (e) {
            e.preventDefault();
            $.ajax({
                method: 'get',
                url: e.target.href,
                success : function( data ) {
                    appendCandidates(data);
                }
            });
        });

        $home.on('change', '#filtros', function (e) {
            e.preventDefault();
            var $filtersForm = $(this);
            var replaceFilters = false;
            var currentFieldName = e.target.name;

            // Só trocamos o filtro quando o estado muda.
            // Caso contrário, apenas trocaremos o
            // conteúdo da div de candidatos.
            if (currentFieldName === "estado") {
                replaceFilters = true;
                $filtersForm.find('[name=cidade]').val('');
            }

            submitForm($filtersForm, replaceFilters).done(function () {
                if (replaceFilters && currentFieldName) {
                    $home.find("[name="+currentFieldName+"]").focus();
                }
            });
        });

        /**
         * Faremos o submit do form de filtros via AJAX e trocaremos
         * as partes necessárias do body (a lista de candidatos
         * ou filtro, por exemplo).
         *
         * @param $filtersForm
         * @param replacingFilters
         * @returns {*}
         */
        function submitForm($filtersForm, replacingFilters = false) {
            return $.ajax({
                url: $filtersForm.attr('action'),
                type: $filtersForm.attr('method'),
                data: $filtersForm.serialize(),
                success : function( data ) {
                    history.pushState("", "" , "?"+$filtersForm.serialize());

                    var $html = $(data);

                    if (replacingFilters) {
                        $home.find('#filtros').replaceWith($html.find('#filtros'));
                    }

                    $home.find('#candidates').replaceWith($html.find('#candidates'));
                },
                error: function( xhr, err ) {
                    console.log('Ocorreu um erro.');
                }
            });
        }

        function appendCandidates(data) {
            $html = $(data);
            $home.find('#candidatesList').append($html.find('#candidatesList').html());
            $home.find('.load-more-btn').replaceWith($(data).find('.load-more-btn'));
        }
    });
</script>
{{end}}